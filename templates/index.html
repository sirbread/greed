<!DOCTYPE html>
<html>
<head>
    <title>greed</title>
    <style>
        #timer {
            position: fixed;
            bottom: 10px;
            left: 0;
            width: 100vw;
            text-align: center;
            font-size: 1.2em;
            color: #333;
            background: #fffffff0;
            padding: 8px 0;
            z-index: 100;
        }
        #scoreboard {
            margin-top: 24px;
        }
        #input-message {
            color: rgb(255, 0, 0);
            margin-top: 0.5em;
        }
        #help-link, #graphs-link {
            margin-bottom: 1.5em;
            display: block;
        }
        .status-in-transit {
            color: red !important;
        }
    </style>
</head>
<body>
    <h1>pick a number (1-10, inclusive, integer)</h1>

    <a id="help-link" href="/help">what is this?</a>
    <a id="graphs-link" href="/graphs">see stats</a>

    <div id="setup">
        <label>Name: <input type="text" id="nameInput"></label>
        <button onclick="saveName()">Save</button>
    </div>

    <div id="game" style="display:none;">
        <input type="number" id="numberInput" min="1" max="10">
        <button onclick="submit()">Submit</button>
        <div id="input-message"></div>
        <div id="status"></div>
    </div>
    
    <div id="scoreboard">
        <h2>Leaderboard (Final Scores)</h2>
        <pre id="scores">Loading...</pre>
    </div>

    <div id="timer">Loading time...</div>

    <script>
        let userId = localStorage.getItem("userId")
        if (!userId) {
            userId = Math.floor(Math.random() * 100000)
            localStorage.setItem("userId", userId)
        }
        userId = parseInt(userId)

        let lastRoundId = null;
        let didInitialPrefill = false;
        let isSubmitting = false;
        let lastSubmittedValue = null;

        function saveName() {
            const name = document.getElementById("nameInput").value.trim()
            if (!name) {
                alert("Please enter a name")
                return
            }
            localStorage.setItem("username", name)
            document.getElementById("setup").style.display = "none"
            document.getElementById("game").style.display = "block"
            prefillAwaitingSubmission()
        }

        function submit() {
            const name = localStorage.getItem("username")
            const value = parseInt(document.getElementById("numberInput").value)
            const inputMsgDiv = document.getElementById("input-message");
            const statusDiv = document.getElementById("status");
            if (isNaN(value) || value < 1 || value > 10) {
                inputMsgDiv.textContent = "Please enter a number from 1 to 10"
                return
            }
            inputMsgDiv.textContent = "";

            isSubmitting = true;
            lastSubmittedValue = value; 
            statusDiv.textContent = "Submitting...";
            statusDiv.classList.add("status-in-transit");

            fetch("/submit/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    user_id: userId, 
                    user_name: name,
                    number_selected: value 
                })
            })
            .then(res => res.json())
            .then(() => {
                document.getElementById("numberInput").value = value;
            })
        }

        function loadScores() {
            fetch("/scores/")
                .then(res => res.json())
                .then(scores => {
                    if (scores.length === 0) {
                        document.getElementById("scores").textContent = "No scores yet."
                        return
                    }
                    document.getElementById("scores").textContent =
                        scores.map((s, i) => `${i+1}. ${s.user_name}: ${s.total_score.toFixed(2)}`).join("\n")
                })
        }

        function updateTimerDisplay(secondsLeft) {
            let timerDiv = document.getElementById("timer");
            let min = Math.floor(secondsLeft / 60);
            let sec = secondsLeft % 60;
            timerDiv.textContent = `Time left this round: ${min}:${sec.toString().padStart(2, '0')}`;
        }

        function checkRoundStatus() {
            fetch("/round/")
                .then(res => res.json())
                .then(data => {
                    updateTimerDisplay(data.time_left_seconds || 0);
                    if (lastRoundId !== data.round_id) {
                        lastRoundId = data.round_id;
                        loadScores();
                        document.getElementById("numberInput").value = "";
                        document.getElementById("status").textContent = "";
                        document.getElementById("status").classList.remove("status-in-transit");
                        document.getElementById("input-message").textContent = "";
                        didInitialPrefill = false;
                        isSubmitting = false;
                        lastSubmittedValue = null;
                    }
                });
        }

        function pollAwaitingSubmission() {
            fetch("/awaiting/?user_id=" + userId)
                .then(res => res.json())
                .then(data => {
                    const statusDiv = document.getElementById("status");
                    if (data && data.number_selected !== undefined) {
                        if (isSubmitting) { 
                            if (data.number_selected === lastSubmittedValue) {
                                isSubmitting = false;
                                statusDiv.textContent = "Submitted number: " + data.number_selected;
                                statusDiv.classList.remove("status-in-transit");
                            } else {
                                statusDiv.textContent = "Submitting...";
                                statusDiv.classList.add("status-in-transit");
                            }
                        } else {
                            statusDiv.textContent = "Submitted number: " + data.number_selected;
                            statusDiv.classList.remove("status-in-transit");
                        }
                        if (!didInitialPrefill) {
                            document.getElementById("numberInput").value = data.number_selected;
                            didInitialPrefill = true;
                        }
                    } else {
                        statusDiv.textContent = "";
                        statusDiv.classList.remove("status-in-transit");
                    }
                })
        }

        const saved = localStorage.getItem("username")
        if (saved) {
            document.getElementById("nameInput").value = saved
            document.getElementById("setup").style.display = "none" 
            document.getElementById("game").style.display = "block"
            prefillAwaitingSubmission()
        }

        function prefillAwaitingSubmission() {
            didInitialPrefill = false;
            pollAwaitingSubmission(); //will prefill on first call if needed
        }

        setInterval(checkRoundStatus, 1000)
        setInterval(pollAwaitingSubmission, 1000)
        loadScores()
        checkRoundStatus()
        pollAwaitingSubmission()
    </script>
</body>
</html>