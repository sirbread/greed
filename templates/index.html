<!DOCTYPE html>
<html>
<head>
    <title>greed</title>
    <style>
        #timer {
            position: fixed;
            bottom: 10px;
            left: 0;
            width: 100vw;
            text-align: center;
            font-size: 1.2em;
            color: #333;
            background: #fffffff0;
            padding: 8px 0;
            z-index: 100;
        }
        #scoreboard {
            margin-top: 24px;
        }
        #input-message {
            color: rgb(255, 0, 0);
            margin-top: 0.5em;
        }
        #help-link, #graphs-link {
            margin-bottom: 1.5em;
            display: block;
        }
        .winner-message {
            font-size: 1.3em;
            color: green;
            margin: 1.5em 0;
        }
        #auth-section {
            margin-bottom: 1em;
        }
        #username-section {
            margin: 1.5em 0;
            display: none;
        }
        #username-error {
            color: red;
            margin-top: 0.5em;
        }
        #pregame-container {
            display: none;
            min-height: 60vh;
            text-align: center;
            padding-top: 15vh;
        }
        #pregame-timer {
            font-size: 2.2em;
            margin: 1em 0 1em 0;
            color: #019239;
        }
        #pregame-username-section {
            margin: 1.5em 0;
        }
        #pregame-username-error {
            color: red;
            margin-top: 0.5em;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "{{ firebase_api_key }}",
        authDomain: "{{ firebase_auth_domain }}",
        projectId: "{{ firebase_project_id }}",
        storageBucket: "{{ firebase_storage_bucket }}",
        messagingSenderId: "{{ firebase_messaging_sender_id }}",
        appId: "{{ firebase_app_id }}"
      };
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
    </script>
</head>
<body>
    <div id="pregame-container">
        <div id="pregame-userinfo"></div>
        <button id="pregame-logout" style="display:none;">logout</button>
        <div style="margin-top:4em;color:#555;">greed is starting in...</div>
        <div id="pregame-timer"></div>
        <div id="pregame-username-section" style="display:none;">
            <label for="pregame-username-input">enter your username:</label>
            <input id="pregame-username-input" type="text" maxlength="20" pattern="^[a-zA-Z0-9_]+$" autocomplete="off" autocapitalize="off">
            <button id="pregame-username-go">go!</button>
            <div id="pregame-username-error"></div>
        </div>
    </div>

    <div id="main-content">
        <h1>pick a number (1-10, inclusive, integer)</h1>
        <h3>first player to reach <span id="winning-score">{{ winning_score }}</span> points wins!</h3>
        <h4 id="round-duration-desc"></h4>
        <a id="help-link" href="/help">what is this?</a>
        <a id="graphs-link" href="/graphs">see stats</a>

        <div id="auth-section">
            <button id="logout" style="display:none;">logout</button>
            <span id="user-info"></span>
        </div>

        <div id="username-section">
            <label for="username-input">enter your username:</label>
            <input id="username-input" type="text" maxlength="20" pattern="^[a-zA-Z0-9_]+$" autocomplete="off" autocapitalize="off">
            <button id="username-go">go!</button>
            <div id="username-error"></div>
        </div>

        <div id="game" style="display:none;">
            <input type="number" id="numberInput" min="1" max="10">
            <button onclick="submit()">submit</button>
            <div id="input-message"></div>
            <div id="status"></div>
        </div>

        <div id="scoreboard">
            <h2>leaderboard</h2>
            <pre id="scores">loading...</pre>
        </div>
        <div id="timer">loading time...</div>
    </div>

    <script>
        let gameStarted = false;
        let startTime = null;
        let pregameInterval = null;
        let lastRoundId = null;
        let didInitialPrefill = false;
        let isSubmitting = false;
        let lastSubmittedValue = null;
        let winnerAnnounced = false;
        let gameEnded = false;
        let currentUser = null;
        let currentToken = null;
        let usernameSet = false;
        let pregameActive = false; 

        function formatCountdown(ms) {
            let s = Math.max(0, Math.floor(ms/1000));
            let d = Math.floor(s/86400);
            s = s % 86400;
            let h = Math.floor(s/3600);
            s = s % 3600;
            let m = Math.floor(s/60);
            s = s % 60;
            return `${d} day${d!==1?'s':''} ${h} hour${h!==1?'s':''} ${m} minute${m!==1?'s':''} ${s} second${s!==1?'s':''}`;
        }

        fetch("/start_time/")
            .then(res => res.json())
            .then(data => {
                startTime = new Date(data.start_time);
                checkPregameState();
            }).catch(() => {
                document.getElementById("pregame-container").style.display = "none";
                document.getElementById("main-content").style.display = "";
                pregameActive = false;
            });

        function checkPregameState() {
            const now = new Date();
            if (startTime && now < startTime) {
                pregameActive = true;
                document.getElementById("pregame-container").style.display = "block";
                document.getElementById("main-content").style.display = "none";
                updatePregameUserInfo();
                updatePregameTimer();
                updatePregameUsernameSection();
            } else {
                pregameActive = false;
                document.getElementById("pregame-container").style.display = "none";
                document.getElementById("main-content").style.display = "";
            }
        }

        function updatePregameUserInfo() {
            document.getElementById("pregame-userinfo").textContent = document.getElementById("user-info").textContent;
            document.getElementById("pregame-logout").style.display =
                document.getElementById("logout").style.display === "inline-block" ? "inline-block" : "none";
        }

        function updatePregameUsernameSection() {
            if (!usernameSet && currentUser) {
                document.getElementById("pregame-username-section").style.display = "block";
            } else {
                document.getElementById("pregame-username-section").style.display = "none";
            }
        }

        function updatePregameTimer() {
            const timerElem = document.getElementById("pregame-timer");
            if (pregameInterval) clearInterval(pregameInterval);
            function tick() {
                const now = new Date();
                const diff = startTime - now;
                if (diff > 0) {
                    timerElem.textContent = formatCountdown(diff);
                } else {
                    timerElem.textContent = "starting...";
                    clearInterval(pregameInterval);
                    setTimeout(() => location.reload(), 1200);
                }
            }
            tick();
            pregameInterval = setInterval(tick, 1000);
        }

        document.getElementById('pregame-logout').onclick = function() {
            auth.signOut();
        };

        document.getElementById('logout').onclick = function() {
            auth.signOut();
        };

        function showUsernameSection() {
            if (!pregameActive) {
                document.getElementById("username-section").style.display = "block";
                document.getElementById("game").style.display = "none";
            }
        }
        function hideUsernameSection() {
            if (!pregameActive) {
                document.getElementById("username-section").style.display = "none";
                document.getElementById("game").style.display = "block";
            }
        }

        function checkIfUsernameSet(token) {
            return fetch("/whoami/", {
                method: "GET",
                headers: {"Authorization": "Bearer " + token}
            })
            .then(res => res.ok ? res.json() : Promise.reject())
            .then(data => !!data.username)
            .catch(() => false);
        }

        function checkAuthAndUsernameOrRedirect() {
            if (!currentUser) {
                window.location.href = '/login';
                return;
            }
            currentUser.getIdToken().then(token => {
                fetch("/whoami/", {
                    method: "GET",
                    headers: {"Authorization": "Bearer " + token}
                })
                .then(res => res.ok ? res.json() : Promise.reject())
                .then(data => {
                    if (!data.username) {
                        window.location.href = '/login';
                    }
                })
                .catch(() => {
                    window.location.href = '/login';
                });
            });
        }

        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (!user) {
                window.location.href = '/login';
                return;
            }
            document.getElementById('logout').style.display = 'inline-block';
            user.getIdToken().then(token => {
                currentToken = token;
                fetch("/whoami/", {
                    method: "GET",
                    headers: {"Authorization": "Bearer " + token}
                })
                .then(res => res.ok ? res.json() : Promise.reject())
                .then(data => {
                    const username = data.username;
                    const googleName = user.displayName || user.email;
                    const userInfoDiv = document.getElementById('user-info');
                    if (username && googleName) {
                        userInfoDiv.textContent = `hello ${username}! you're logged in as ${googleName}.`;
                    } else if (googleName) {
                        userInfoDiv.textContent = `welcome to greed! you're logged in as ${googleName}`;
                    } else {
                        userInfoDiv.textContent = "";
                    }
                    usernameSet = !!data.username;
                    updatePregameUserInfo();
                    updatePregameUsernameSection();
                    if (!usernameSet) {
                        window.location.href = '/login';
                    } else if (!pregameActive) {
                        hideUsernameSection();
                    }
                })
                .catch(() => {
                    document.getElementById('user-info').textContent = "";
                    usernameSet = false;
                    window.location.href = '/login';
                });
            });
        });

        //fo pre game gng
        document.getElementById("pregame-username-go").onclick = function() {
            const username = document.getElementById("pregame-username-input").value.trim();
            const errorDiv = document.getElementById("pregame-username-error");
            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                errorDiv.textContent = "invalid username (letters, numbers, dashes, underscores only)";
                return;
            }
            if (username.length < 2 || username.length > 20) {
                errorDiv.textContent = "username must be 2-20 characters";
                return;
            }
            errorDiv.textContent = "";
            fetch("/set_username/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + currentToken
                },
                body: JSON.stringify({username})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    usernameSet = true;
                    const googleName = currentUser.displayName || currentUser.email;
                    document.getElementById('user-info').textContent =
                        `hello ${username}! you're logged in as ${googleName}.`;
                    updatePregameUserInfo();
                    updatePregameUsernameSection();
                } else if (data.error === "taken") {
                    errorDiv.textContent = "this username is taken gng";
                } else if (data.error === "invalid") {
                    errorDiv.textContent = "invalid username gng (letters/numbers/underscores only)";
                } else {
                    errorDiv.textContent = "some thing happened, your thing didn't happen though ";
                }
            })
            .catch(() => {
                errorDiv.textContent = "the server is cooked gng ";
            });
        };

        //for main game gng \/
        document.getElementById("username-go").onclick = function() {
            const username = document.getElementById("username-input").value.trim();
            const errorDiv = document.getElementById("username-error");
            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                errorDiv.textContent = "invalid username (letters, numbers, dashes, underscores only)";
                return;
            }
            if (username.length < 2 || username.length > 20) {
                errorDiv.textContent = "username must be 2-20 characters";
                return;
            }
            errorDiv.textContent = "";
            fetch("/set_username/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + currentToken
                },
                body: JSON.stringify({username})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    hideUsernameSection();
                    usernameSet = true;
                    const googleName = currentUser.displayName || currentUser.email;
                    document.getElementById('user-info').textContent =
                        `hello ${document.getElementById("username-input").value.trim()}! you're logged in as ${googleName}.`;
                    updatePregameUserInfo();
                    updatePregameUsernameSection();
                } else if (data.error === "taken") {
                    errorDiv.textContent = "this username is taken gng";
                } else if (data.error === "invalid") {
                    errorDiv.textContent = "invalid username gng (letters/numbers/underscores only)";
                } else {
                    errorDiv.textContent = "some thing happened, your thing didn't happen though ";
                }
            })
            .catch(() => {
                errorDiv.textContent = "the server is cooked gng ";
            });
        };

        function submit() {
            const value = parseInt(document.getElementById("numberInput").value);
            const inputMsgDiv = document.getElementById("input-message");
            const statusDiv = document.getElementById("status");
            if (!currentUser) {
                inputMsgDiv.textContent = "please sign in first.";
                return;
            }
            if (!usernameSet) {
                inputMsgDiv.textContent = "please set your username first";
                return;
            }
            if (isNaN(value) || value < 1 || value > 10) {
                inputMsgDiv.textContent = "please enter a number from 1 to 10";
                return;
            }
            inputMsgDiv.textContent = "";

            isSubmitting = true;
            lastSubmittedValue = value;
            statusDiv.textContent = "submitting...";
            statusDiv.classList.add("status-in-transit");

            currentUser.getIdToken(true).then(token => {
                currentToken = token;
                fetch("/submit/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify({
                        number_selected: value
                    })
                })
                .then(res => res.json())
                .then(() => {
                    document.getElementById("numberInput").value = value;
                })
            });
        }

        function loadScores() {
            fetch("/scores/")
                .then(res => res.json())
                .then(scores => {
                    if (scores.length === 0) {
                        document.getElementById("scores").textContent = "no scores yet."
                        return
                    }
                    document.getElementById("scores").textContent =
                        scores.map((s, i) => `${i+1}. ${s.user_name}: ${s.total_score.toFixed(2)}`).join("\n")
                })
        }

        function updateTimerDisplay(secondsLeft) {
            let timerDiv = document.getElementById("timer");
            if (gameEnded) {
                timerDiv.textContent = "timer: ENDED";
                return;
            }
            let min = Math.floor(secondsLeft / 60);
            let sec = secondsLeft % 60;
            timerDiv.textContent = `time left this round: ${min}:${sec.toString().padStart(2, '0')}`;
        }

        function checkRoundStatus() {
            if (pregameActive || gameEnded) return; // <--- don't poll during pregame dumbass
            fetch("/round/")
                .then(res => res.json())
                .then(data => {
                    updateTimerDisplay(data.time_left_seconds || 0);
                    if (lastRoundId !== data.round_id) {
                        lastRoundId = data.round_id;
                        loadScores();
                        document.getElementById("numberInput").value = "";
                        document.getElementById("status").textContent = "";
                        document.getElementById("status").classList.remove("status-in-transit");
                        document.getElementById("input-message").textContent = "";
                        didInitialPrefill = false;
                        isSubmitting = false;
                        lastSubmittedValue = null;
                        checkForWinner();
                    }
                });
        }

        function checkForWinner() {
            if (pregameActive) return; // don't poll during pregame dumbass
            fetch("/winner/")
                .then(res => res.json())
                .then(data => {
                    if (data.winner && !winnerAnnounced) {
                        winnerAnnounced = true;
                        gameEnded = true;
                        showWinner(data.user_name, data.user_id, data.score);
                        updateTimerDisplay(0); 
                    }
                });
        }

        function showWinner(name, id, score) {
            const gameDiv = document.getElementById("game");
            gameDiv.innerHTML = `<div class="winner-message">
            congratulations <b>${name}</b> (ID: ${id})!<br>
            you won with a score of ${score}.
            </div>`;
        }

        function pollAwaitingSubmission() {
            if (pregameActive || gameEnded || !currentUser) return; //don't poll during pregame dumbass
            currentUser.getIdToken().then(token => {
                fetch("/awaiting/", {
                    headers: {
                        "Authorization": "Bearer " + token
                    }
                })
                .then(res => res.json())
                .then(data => {
                    const statusDiv = document.getElementById("status");
                    if (data && data.number_selected !== undefined) {
                        if (isSubmitting) { 
                            if (data.number_selected === lastSubmittedValue) {
                                isSubmitting = false;
                                statusDiv.textContent = "submitted number: " + data.number_selected;
                                statusDiv.classList.remove("status-in-transit");
                            } else {
                                statusDiv.textContent = "submitting...";
                                statusDiv.classList.add("status-in-transit");
                            }
                        } else {
                            statusDiv.textContent = "submitted number: " + data.number_selected;
                            statusDiv.classList.remove("status-in-transit");
                        }
                        if (!didInitialPrefill) {
                            document.getElementById("numberInput").value = data.number_selected;
                            didInitialPrefill = true;
                        }
                    } else {
                        statusDiv.textContent = "";
                        statusDiv.classList.remove("status-in-transit");
                    }
                });
            });
        }

        function prefillAwaitingSubmission() {
            didInitialPrefill = false;
            pollAwaitingSubmission();
        }

        function formatDuration(seconds) {
            let parts = [];
            let h = Math.floor(seconds / 3600);
            let m = Math.floor((seconds % 3600) / 60);
            let s = seconds % 60;
            if (h > 0) parts.push(h + " hour" + (h !== 1 ? "s" : ""));
            if (m > 0) parts.push(m + " minute" + (m !== 1 ? "s" : ""));
            if (s > 0) parts.push(s + " second" + (s !== 1 ? "s" : ""));
            return parts.join(", ");
        }
        function setRoundDurationDesc() {
            fetch("/config/")
                .then(res => res.json())
                .then(cfg => {
                    let desc = formatDuration(cfg.round_duration_seconds);
                    document.getElementById("round-duration-desc").textContent =
                        "each round lasts: " + desc + ".";
                });
        }
        setRoundDurationDesc();

        setInterval(checkRoundStatus, 1000)
        setInterval(pollAwaitingSubmission, 1000)
        loadScores()
        checkRoundStatus()
        pollAwaitingSubmission()
    </script>
</body>
</html>